Блок-схема алгоритма:
text
┌─────────────────────────┐
│     ИНИЦИАЛИЗАЦИЯ       │
├─────────────────────────┤
│ 1. TVI = 0              │
│ 2. CountB = 0           │
│ 3. TVIm = -40           │
│ 4. TVIp = 80            │
│ 5. CscdG = fGetCscdG()  │
│ 6. Запуск таймера       │
│    fTestTVI каждые 5 сек│
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   ТАЙМЕР (каждые 5 сек) │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│      fTestTVI()         │
├─────────────────────────┤
│ 1. cB = fCountB()       │
│ 2. Проверка изменения   │
│    количества котлов    │
└───────────┬─────────────┘
     ├───────────────┤
     │ Изменилось?   │
     ▼               ▼
┌─────────┐   ┌───────────────┐
│   Да    │   │      Нет      │
├─────────┤   ├───────────────┤
│ TVI = 0 │   │ TVI = fCalcTVI│
│ CountB=cB│   │ (интеграл)   │
└────┬────┘   └───────┬───────┘
     │                │
     └────────┬───────┘
              │
              ▼
      ┌───────────────┐
      │ fPubSensT()   │
      │ Опубликовать  │
      │ значения TVI  │
      └───────┬───────┘
              │
              ▼
      ┌───────────────┐
      │   fSetTCas()  │
      └───────┬───────┘
              │
              ▼
      ┌───────────────┐
      │ Для i=1..CountB│
      │   fSetMask()  │
      └───────┬───────┘
              │
              ▼
      ┌───────────────┐
      │ fSetMask():   │
      │ 1. Получить   │
      │    маску котла│
      │ 2. Вычислить  │
      │    уставку    │
      │ 3. Установить │
      │    уставку    │
      └───────────────┘
Подробная блок-схема основных функций:
fCountB (определение количества котлов):
text
          ┌─────────────────┐
          │ Вход: CountB, TVI│
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ TVI < TVIm (-40)?│
          └────────┬────────┘
        Да │          │ Нет
           ▼          ▼
    ┌────────────┐ ┌─────────────────┐
    │cB = CountB+1│ │ TVI > TVIp (80)?│
    │(max 3)     │ └────────┬────────┘
    └────────────┘    Да │          │ Нет
                         ▼          ▼
                   ┌────────────┐ ┌────────────┐
                   │cB = CountB-1│ │cB = CountB │
                   │(min 1)     │ │            │
                   └────────────┘ └────────────┘
fCalcTVI (расчет интегрального показателя):
text
┌─────────────────┐
│ Вход: текущий TVI│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ cT = fGetCt()   │
│ (факт. темп.)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ sT = fGetTt()   │
│ (треб. темп.)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ dT = cT - sT    │
│ (разность)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ TVI = TVI + dT/6│
│ (интеграл)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Вернуть TVI     │
└─────────────────┘
fSetTCas и fSetMask (назначение уставок):
text
┌─────────────────┐
│ fSetTCas()      │
├─────────────────┤
│ Получить список │
│ котлов cLsB     │
├─────────────────┤
│ Получить sT     │
│ (треб. темп.)   │
├─────────────────┤
│ Для i=1..CountB │
│   fSetMask()    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ fSetMask()      │
├─────────────────┤
│ Получить маску  │
│ котла из списка │
├─────────────────┤
│ i <= CountB?    │
│   Да: Вычислить │
│     sTemp по    │
│     формуле     │
│   Нет: sTemp =  │
│     450+2730    │
├─────────────────┤
│ Установить      │
│ уставку котла   │
└─────────────────┘
Логика работы:
Цикл управления (каждые 5 секунд):

Мониторинг температуры

Расчет интегрального показателя (TVI)

Решение о включении/выключении котлов

Корректировка уставок температуры

Управление котлами:

При низком TVI (< -40) - увеличить количество котлов

При высоком TVI (> 80) - уменьшить количество котлов

Каждый следующий котел имеет уставку на 40°C ниже предыдущего

Формула уставок: sTemp = sT + 2730 + 60 - 40*(i-1)

sT - требуемая температура

2730 - смещение для внутреннего представления

60 - базовое превышение

40*(i-1) - снижение для каждого следующего котла

Код теперь корректно обрабатывает все сценарии, включая граничные условия.

