DATA=$(curl -s "https://api.weatherapi.com/v1/forecast.json?key=8f9a4a9f7eee4ff1bf1124207250807&q=auto:ip&days=1&aqi=no&alerts=no") && current_epoch=$(date +%s) && AVAILABLE_HOURS=$(echo "$DATA" | jq -r '.forecast.forecastday[0].hour[].time_epoch') && for h in 0 1 2 3; do target_epoch=$((current_epoch + h * 3600)) && closest_epoch=$(echo "$AVAILABLE_HOURS" | awk -v target=$target_epoch '{diff=($1-target)^2;if(diff<min_diff||min_diff==""){min_diff=diff;closest=$1}} END{print closest}') && HOUR_FORECAST=$(echo "$DATA" | jq -r --argjson epoch $closest_epoch '.forecast.forecastday[0].hour[] | select(.time_epoch == $epoch) | with_entries(select(.value != null))') && if [ -n "$HOUR_FORECAST" ] && [ "$HOUR_FORECAST" != "null" ]; then mosquitto_pub -t "weather/forecast_${h}h" -m "$HOUR_FORECAST" -r; else mosquitto_pub -t "weather/error" -m "Нет данных для +${h}ч" -r; fi; done
